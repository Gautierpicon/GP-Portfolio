name: Dependabot Auto Update Lock Files

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lockfiles:
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Bun
        if: contains(github.event.pull_request.labels.*.name, 'frontend')
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Update Bun lock file
        if: contains(github.event.pull_request.labels.*.name, 'frontend')
        run: |
          cd frontend
          bun install
          cd ..

      - name: Setup Python
        if: contains(github.event.pull_request.labels.*.name, 'backend')
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install uv
        if: contains(github.event.pull_request.labels.*.name, 'backend')
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Update uv lock file
        if: contains(github.event.pull_request.labels.*.name, 'backend')
        run: |
          cd backend
          uv sync
          cd ..

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet frontend/bun.lockb backend/uv.lock 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push lock files
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add frontend/bun.lockb backend/uv.lock || true
          
          # Détermine le message selon le type de dépendance
          if [ -f "frontend/bun.lockb" ] && git diff --staged --quiet -- frontend/bun.lockb; then
            COMMIT_MSG="chore(backend): update uv.lock"
          elif [ -f "backend/uv.lock" ] && git diff --staged --quiet -- backend/uv.lock; then
            COMMIT_MSG="chore(frontend): update bun.lockb"
          else
            COMMIT_MSG="chore: update lock files"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push origin ${{ github.event.pull_request.head.ref }}

      - name: Comment on PR
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Lock files have been automatically updated in this PR.'
            })